#!/bin/bash

source ~/.dotfiles.env

append=''
append_lines=''
no_new_line=''
pipe_input=''
pipe_output=''

main() {
    parse_args "$@"

    if [[ -n "$pipe_input" ]]; then
        new_content="$(get_new_content)"
        echo -n "$new_content" | copy
    fi

    paste | cat
}

FILE_ONLY_MODE="${DOTFILES_CONFIG_CLIPBOARD_FILE_ONLY_MODE:-false}"
if [[ "$FILE_ONLY_MODE" != 'true' ]] && ( which xsel && xsel -ob ) > /dev/null 2>&1; then
    copy  () { xsel -ib; }
    paste () { xsel -ob; }
elif [ "${IS_MACOS:-false}" = 'true' ] && ( which pbcopy ) > /dev/null 2>&1; then
    copy  () { pbcopy; }
    paste () { pbpaste; }
else
    CLIPBOARD_FILE="${DOTFILES_CONFIG_CLIPBOARD_FILE:-$DOTFILES_ENV_HOME/.clipboard}"

    [[ ! -f "$CLIPBOARD_FILE" ]] && mkdir -p "$(dirname "$CLIPBOARD_FILE")" && touch "$CLIPBOARD_FILE"
    chown "$DOTFILES_ENV_USER" "$CLIPBOARD_FILE"
    chmod 600 "$CLIPBOARD_FILE"

    copy  () { cat > "$CLIPBOARD_FILE"; }
    paste () { cat   "$CLIPBOARD_FILE"; }
fi

parse_args() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -a) append='true' ;;
            -l) append='true'; append_lines='true' ;;
            -s) no_new_line='true' ;;
            *)
                echo >&2 "Invalid arguments: $1"
                echo >&2 "Usage: clipboard [-a] [-l] [-s]"
                exit 1
            ;;
        esac
        shift
    done

    [[ ! -t 0 ]] && pipe_input='true'
    [[ ! -t 1 ]] && pipe_output='true'
}

get_new_content() {
    if [[ -n "$append" ]]; then
        echo -n "$(paste)"

        if [[ -n "$append_lines" ]]; then
            echo
        fi
    fi

    echo -n "$(cat)"

    if [[ -z "$no_new_line" ]]; then
        echo
    fi
}

main "$@"
